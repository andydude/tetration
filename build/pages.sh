#!/bin/bash
TEMPLATES_SUBDIR="templates"
VIEWMODEL_SUBDIR="content"
BUILD_DIR="./"
PROJECT_DIR="../"
TEMPLATES_DIR="${PROJECT_DIR}${TEMPLATES_SUBDIR}/"
TEMPLATES=$(ls ${TEMPLATES_DIR}* | grep -v '~$')
TEMPLATES_MAKE=$(for TEMP in ${TEMPLATES}; do printf '\\\n\t%s ' $TEMP; done)
PAGES=$(find .. -name '*.html' | grep "/${VIEWMODEL_SUBDIR}/"'.*\.html' | sed "s|/${VIEWMODEL_SUBDIR}/|/|g")
PAGES_MAKE=$(for PAGE in ${PAGES}; do printf '\\\n\t%s ' $PAGE; done)
SUBDIRS=$(echo $(find .. -name "${VIEWMODEL_SUBDIR}" | sed "s|/${VIEWMODEL_SUBDIR}||g" | sort))
cat > pages.mk <<EOF
##
## Automatically generated by drosera-boilerplate -- DO NOT EDIT!
##

PAGES = ${PAGES_MAKE}

TEMPLATES = ${TEMPLATES_MAKE}

EOF

cat > rules.mk <<EOF
##
## Automatically generated by drosera-boilerplate -- DO NOT EDIT!
##

EOF

for SUBDIR in ${SUBDIRS}; do
cat >> rules.mk <<EOF
${SUBDIR}/%.html: ${SUBDIR}/${VIEWMODEL_SUBDIR}/%.html ${SUBDIR}/${VIEWMODEL_SUBDIR}/%.json \$(TEMPLATES)
	./page.sh \$< > \$@

EOF
done
